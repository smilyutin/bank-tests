name: Test Vulnerable Bank Application

on:
  # Allow other workflows to call this one directly
  workflow_call:
    inputs:
      app_branch:
        required: false
        type: string
        default: 'main'
      soft_mode:
        required: false
        type: string
        default: 'false'
      test_suite:
        required: false
        type: string
        default: 'security'
    secrets:
      PAT:
        required: false

  # Run on push to dev branch only
  push:
    branches:
      - dev
    paths:
      - 'tests/security/**'
      - 'playwright.config.ts'
      - '.github/workflows/**'
  
  # Run on PRs to dev branch
  pull_request:
    branches:
      - dev
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      app_branch:
        description: 'APP branch to test'
        required: false
        default: 'main'
        type: string
      soft_mode:
        description: 'Run in SOFT mode (warnings vs failures)'
        required: false
        default: 'false'
        type: string
      test_suite:
        description: 'Which tests to run'
        required: false
        default: 'security'
        type: string

  # Scheduled runs (every Monday at 2 AM UTC)
  schedule:
    - cron: '0 2 * * 1'

env:
  APP_REPO: 'smilyutin/vuln_bank'
  APP_BRANCH: ${{ (github.event_name == 'workflow_call' && inputs.app_branch) || (github.event_name == 'workflow_dispatch' && github.event.inputs.app_branch) || 'main' }}
  SOFT_MODE: ${{ (github.event_name == 'workflow_call' && inputs.soft_mode) || (github.event_name == 'workflow_dispatch' && github.event.inputs.soft_mode) || 'false' }}
  TEST_SUITE: ${{ (github.event_name == 'workflow_call' && inputs.test_suite) || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_suite) || 'security' }}
  BASE_URL: 'http://localhost:5001'
  NODE_VERSION: '20'
  ALLURE_RESULTS_DIR: ${{ github.workspace }}/test-repo/allure-results
  ALLURE_REPORT_DIR: ${{ github.workspace }}/test-repo/allure-report

jobs:
  test-application:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # Push to gh-pages
      pull-requests: write # Add comments to PRs

    env:
      PAT: ${{ secrets.PAT }}

    steps:
      - name: Check for PAT secret (optional)
        run: |
          if [ -z "${{ secrets.PAT }}" ]; then
            echo "WARNING: secrets.PAT is not set. Will fall back to GITHUB_TOKEN where possible."
          else
            echo "PAT secret is set."
          fi

      # ==================== SETUP TEST REPO ====================
      - name:  Checkout Test Repo
        uses: actions/checkout@v4
        with:
          path: test-repo
      
      - name:  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'test-repo/package-lock.json'
        continue-on-error: true
          
      - name:  Install Allure CLI
        run: |
          echo "Installing Allure CLI..."
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure_2.24.0-1_all.deb
          sudo dpkg -i allure_2.24.0-1_all.deb || sudo apt-get install -f -y
          echo "/usr/bin" >> $GITHUB_PATH
          echo "Allure version: $(allure --version || echo 'Allure not found')"
      
      - name: Install System Dependencies
        run: |
          echo "Updating package lists..."
          sudo apt-get update -qq
          echo "Installing required system dependencies for Ubuntu 24.04..."
          sudo apt-get install -y --no-install-recommends \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libnss3-tools \
            libx11-6 \
            libxcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            libxshmfence1 \
            libxss1 \
            libxtst6 \
            xvfb \
            x11-utils \
            x11-xserver-utils
          echo "Installing Playwright system dependencies..."
          npx playwright install --with-deps chromium
          # npx playwright install-deps  # redundant, already covered above
          echo "System dependencies installed successfully"
      
      - name: Install Test Dependencies
        working-directory: ./test-repo
        run: |
          echo "Current directory: $(pwd)"
          echo "Setting up test-repo dependencies..."
          rm -rf node_modules package-lock.json
          echo "Creating package.json..."
          node -e 'require("fs").writeFileSync("package.json", JSON.stringify({name:"bank-tests",version:"1.0.0",private:true,scripts:{test:"playwright test"},devDependencies:{"@playwright/test":"1.40.0","allure-playwright":"2.0.0"}}, null, 2) + "\n")'
          npm config set registry https://registry.npmjs.org/
          npm cache clean --force
          npm install --no-audit --no-fund --prefer-offline
          echo "Dependencies installed"
          echo "Installed packages:"
          npm list --depth=0
          echo "Installing Playwright browsers..."
          npx playwright install chromium
          npx playwright --version

      # Clone APP Repo with fallback for PAT
      - name: Clone APP Repo (with PAT)
        if: env.PAT != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_REPO }}
          ref: ${{ env.APP_BRANCH }}
          path: app-repo
          token: ${{ env.PAT }}
      - name: Clone APP Repo (with GITHUB_TOKEN)
        if: env.PAT == ''
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_REPO }}
          ref: ${{ env.APP_BRANCH }}
          path: app-repo
          token: ${{ github.token }}
      
      - name: Setup Node.js for APP
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name:  Install APP Dependencies
        working-directory: ./app-repo
        run: |
          echo "Installing dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
      
      - name:  Setup Docker Configuration
        working-directory: ./app-repo
        run: |
          if [ ! -f "docker-compose.yml" ]; then
            echo "  No docker-compose.yml found, creating one..."
            printf '%s\n' \
              "version: '3.8'" \
              "services:" \
              "  app:" \
              "    build: ." \
              "    ports:" \
              "      - \"5001:5001\"" \
              "    environment:" \
              "      - NODE_ENV=test" \
              "      - PORT=5001" \
              "    healthcheck:" \
              "      test: [\"CMD-SHELL\", \"curl -f http://localhost:5001/health || curl -f http://localhost:5001/ || exit 1\"]" \
              "      interval: 10s" \
              "      timeout: 5s" \
              "      retries: 5" \
              "      start_period: 30s" \
              > docker-compose.yml
          else
            echo " Found existing docker-compose.yml"
          fi
          if [ ! -f "Dockerfile" ]; then
            echo " No Dockerfile found, creating one..."
            printf '%s\n' \
              "FROM node:20-alpine" \
              "WORKDIR /app" \
              "COPY package*.json ./" \
              "RUN npm ci --only=production || npm install --production" \
              "COPY . ." \
              "EXPOSE 5001" \
              "HEALTHCHECK --interval=10s --timeout=5s --start-period=30s CMD wget --no-verbose --tries=1 --spider http://localhost:5001/health || exit 1" \
              "CMD [\"npm\", \"start\"]" \
              > Dockerfile
          else
            echo "Found existing Dockerfile"
          fi
          echo "=== Docker Configuration ==="
          echo "Dockerfile:"
          cat Dockerfile
          echo ""
          echo "docker-compose.yml:"
          cat docker-compose.yml
      
      - name: Build APP Docker Image
        working-directory: ./app-repo
        run: |
          echo "Building Docker image..."
          docker build -t vuln-bank:test .
          echo "Image built successfully"
          docker images | grep vuln-bank
      
      # ==================== START APP ====================
      - name:  Start APP Container
        working-directory: ./app-repo
        run: |
          echo "Starting application..."
          docker compose up -d
          echo "Waiting for container to initialize..."
          sleep 10
          echo "Container status:"
          docker compose ps
          docker ps
      
      - name: Wait for APP to be Ready
        run: |
          echo "Waiting for application to respond..."
          timeout 120 bash -c '
            until curl -f http://localhost:5001/health 2>/dev/null || curl -f http://localhost:5001/ 2>/dev/null; do 
              echo "Waiting for app... ($(date +%T))"
              docker ps
              sleep 3
            done
          '
          echo " Application is ready!"
      
      - name:  Verify APP Endpoints
        run: |
          echo "=== Testing Endpoints ==="
          echo "Main endpoint:"
          curl -v http://localhost:5001/ 2>&1 | head -20 || echo "Failed"
          echo ""
          echo "Health endpoint:"
          curl -v http://localhost:5001/health 2>&1 || echo "  No health endpoint"
          echo ""
          echo "API endpoint:"
          curl -v http://localhost:5001/api/ 2>&1 || echo " No API endpoint"
      
      - name:  Seed Database with Test Users
        working-directory: ./test-repo
        run: |
          echo "Seeding database with fixture users..."
          if [ ! -f tests/fixtures/users.json ]; then
            echo "No users.json found, skipping seeding."
            exit 0
          fi
          node -e "
          const fs = require('fs');
          const http = require('http');
          const users = JSON.parse(fs.readFileSync('tests/fixtures/users.json', 'utf8')).users;
          console.log('Found ' + users.length + ' users to seed');
          async function createUser(user) {
            return new Promise((resolve) => {
              const data = JSON.stringify({
                username: user.username || user.email.split('@')[0],
                email: user.email,
                password: user.password
              });
              const options = {
                hostname: 'localhost',
                port: 5001,
                path: '/api/register',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': data.length
                }
              };
              const req = http.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => body += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200 || res.statusCode === 201) {
                    console.log(' Created user: ' + user.username);
                  } else if (res.statusCode === 409 || res.statusCode === 400) {
                    console.log('â„¹  User exists: ' + user.username);
                  } else {
                    console.log('  Status ' + res.statusCode + ' for: ' + user.username);
                  }
                  resolve();
                });
              });
              req.on('error', (e) => {
                console.log(' Error creating ' + user.username + ': ' + e.message);
                resolve();
              });
              req.write(data);
              req.end();
            });
          }
          (async () => {
            for (const user of users.slice(0, 10)) {
              await createUser(user);
              await new Promise(r => setTimeout(r, 200));
            }
            console.log(' Database seeding complete!');
          })();
          "
      
      - name:  Show APP Startup Logs
        if: always()
        working-directory: ./app-repo
        run: |
          echo "=== Application Logs (last 100 lines) ==="
          docker compose logs --tail=100
      
      # ==================== RUN TESTS ====================
      - name:  Run Tests
        working-directory: ./test-repo
        env:
          BASE_URL: ${{ env.BASE_URL }}
          SECURITY_SOFT: ${{ env.SOFT_MODE }}
          ALLURE_RESULTS_DIR: ${{ env.ALLURE_RESULTS_DIR }}
        run: |
          echo "================================================"
          echo " Test Configuration"
          echo "================================================"
          echo "Target URL:    $BASE_URL"
          echo "SOFT mode:     $SECURITY_SOFT"
          echo "Test suite:    $TEST_SUITE"
          echo "APP branch:    $APP_BRANCH"
          echo "Allure Results: $ALLURE_RESULTS_DIR"
          echo "================================================"
          mkdir -p $ALLURE_RESULTS_DIR
          EXIT_CODE=0
          echo " Running $TEST_SUITE tests with Allure reporting..."
          echo " Starting tests..."
          timeout 15m npx playwright test tests/$TEST_SUITE/ \
            --reporter=line,allure-playwright \
            --output=$ALLURE_RESULTS_DIR \
            --workers=2 \
            --timeout=300000 || EXIT_CODE=$?
          if [ $EXIT_CODE -eq 124 ]; then
            echo " Tests timed out after 15 minutes"
            EXIT_CODE=0
          fi
          echo " Test results collected in: $ALLURE_RESULTS_DIR"
          find $ALLURE_RESULTS_DIR -type f | xargs ls -la 2>/dev/null || echo "No test results found"
          if [ $EXIT_CODE -ne 0 ]; then
            if [ "$SECURITY_SOFT" = "true" ]; then
              echo "  Tests found issues (SOFT mode - not failing build)"
              EXIT_CODE=0
            else
              echo " Tests failed (HARD mode - failing build)"
            fi
          else
            echo " Tests completed successfully"
          fi
          exit $EXIT_CODE
      
      # ==================== DATABASE VALIDATION ====================
      - name:  Validate Database (Check for Mass Assignment)
        if: always()
        working-directory: ./test-repo
        continue-on-error: true
        run: |
          echo "=== Database Validation ==="
          CONTAINER_NAME=$(docker ps --format '{{.Names}}' | grep -E 'vuln|bank|app' | head -1)
          if [ -n "$CONTAINER_NAME" ]; then
            echo "Found container: $CONTAINER_NAME"
            node scripts/validate-db.js --container="$CONTAINER_NAME"
          else
            echo "  No container found for database validation"
            echo "Skipping database validation (container not available)"
          fi
      
      # ==================== GENERATE REPORTS ====================
      - name:  Generate Allure Report
        if: always()
        working-directory: ./test-repo
        env:
          ALLURE_RESULTS_DIR: ${{ env.ALLURE_RESULTS_DIR }}
          ALLURE_REPORT_DIR: ${{ env.ALLURE_REPORT_DIR }}
        run: |
          echo "=== Generating Allure Report ==="
          mkdir -p "$ALLURE_RESULTS_DIR" "$ALLURE_REPORT_DIR"
          if [ -z "$(ls -A "$ALLURE_RESULTS_DIR/" 2>/dev/null)" ]; then
            echo '{"name": "No test results found", "status": "broken"}' > "$ALLURE_RESULTS_DIR/no-results.json"
            echo "  No test results found. Using placeholder."
          fi
          echo " Generating report from: $ALLURE_RESULTS_DIR"
          rm -rf "$ALLURE_REPORT_DIR"
          allure generate "$ALLURE_RESULTS_DIR" --clean -o "$ALLURE_REPORT_DIR"
          if [ ! -f "$ALLURE_REPORT_DIR/index.html" ]; then
            echo " Creating placeholder index.html..."
            echo "<h1>Allure Report</h1><p>No test results found. Check the test run for details.</p>" > "$ALLURE_REPORT_DIR/index.html"
          fi
          echo " Creating .nojekyll..."
          touch "$ALLURE_REPORT_DIR/.nojekyll"
          echo " Report generated at: $ALLURE_REPORT_DIR"
          echo " Report directory contents:"
          ls -la "$ALLURE_REPORT_DIR"
      
      - name:  Prepare GitHub Pages
        if: always()
        run: |
          echo "Current directory structure:"
          ls -la
          echo "Contents of $ALLURE_REPORT_DIR:"
          ls -la "$ALLURE_REPORT_DIR/"
          rm -rf ./deploy-report
          mkdir -p ./deploy-report
          echo "Copying report to deploy-report/"
          cp -R "$ALLURE_REPORT_DIR/." ./deploy-report/
          echo "Contents of deploy-report/:"
          ls -la ./deploy-report/
      
      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ github.token }}
          # personal_token: ${{ secrets.PAT }}  # REMOVE, not a valid input
          publish_branch: gh-pages
          publish_dir: ./deploy-report
          force_orphan: true
          commit_message: 'Deploy Allure Report [skip ci]'
      
      - name: Add Report URL to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const reportUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/`
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `[View Allure Report](${reportUrl})`
            })
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ github.run_number }}
          path: |
            test-repo/allure-results
            test-repo/allure-report
            test-repo/playwright-report
            test-repo/test-results
          retention-days: 7
          if-no-files-found: ignore
      
      # ==================== COLLECT LOGS ====================
      - name:  Collect APP Logs
        if: always()
        working-directory: ./app-repo
        run: |
          mkdir -p ../app-logs
          echo "Collecting docker compose logs..."
          docker compose logs > ../app-logs/docker-compose.log 2>&1
          echo "Collecting container logs..."
          docker logs $(docker compose ps -q app) > ../app-logs/app-container.log 2>&1 || true
          echo "Collecting system info..."
          docker ps > ../app-logs/docker-ps.log 2>&1
          docker images > ../app-logs/docker-images.log 2>&1
      
      - name:  Upload APP Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs-${{ github.run_number }}
          path: app-logs/
          retention-days: 30
      
      # ==================== CLEANUP ====================
      - name:  Stop and Remove Containers
        if: always()
        working-directory: ./app-repo
        run: |
          echo "Stopping containers..."
          docker compose down -v --remove-orphans || true
          echo "Cleaning up Docker resources..."
          docker system prune -f
      
      - name:  Verify Cleanup
        if: always()
        run: |
          echo "=== Remaining Containers ==="
          docker ps -a
          echo ""
          echo "=== Remaining Volumes ==="
          docker volume ls
          echo ""
          echo "=== Disk Usage ==="
          docker system df
      
      # ==================== SUMMARY ====================
      - name:  Test Summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| APP Repo | \`${{ env.APP_REPO }}@${{ env.APP_BRANCH }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SOFT Mode | \`${{ env.SOFT_MODE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          REPORT_URL="https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "###  Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- [View Allure Report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          if [ -d "test-repo/allure-results" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "###  Test Statistics" >> $GITHUB_STEP_SUMMARY
            TOTAL_TESTS=$(find test-repo/allure-results -name "*.json" | wc -l)
            PASSED_TESTS=$(grep -r "status\":\"passed\"" test-repo/allure-results | wc -l || echo 0)
            FAILED_TESTS=$(grep -r "status\":\"failed\"" test-repo/allure-results | wc -l || echo 0)
            echo "-  Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "-  Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "-  Total: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          fi
