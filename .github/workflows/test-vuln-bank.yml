name: Test Vulnerable Bank Application

on:
  # Run on push to dev branch only
  push:
    branches: [dev]
    paths:
      - 'tests/security/**'  # Only watch security test files
      - 'playwright.config.ts'
      - '.github/workflows/**'
  
  # Run on PRs to dev branch
  pull_request:
    branches: [dev]
  
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      app_branch:
        description: 'APP branch to test'
        required: false
        default: 'main'
        type: string
      soft_mode:
        description: 'Run in SOFT mode (warnings vs failures)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      test_suite:
        description: 'Which tests to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'api'
          - 'security'
          - 'ui'
  
  # Scheduled runs (nightly at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

env:
  APP_REPO: 'smilyutin/vuln_bank'
  APP_BRANCH: ${{ inputs.app_branch || 'main' }}
  SOFT_MODE: ${{ inputs.soft_mode || 'true' }}
  TEST_SUITE: ${{ inputs.test_suite || 'all' }}
  BASE_URL: 'http://localhost:5001'
  NODE_VERSION: '20'
  ALLURE_RESULTS_DIR: ${{ github.workspace }}/test-repo/allure-results
  ALLURE_REPORT_DIR: ${{ github.workspace }}/test-repo/allure-report

jobs:
  test-application:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # For pushing to the repository
      pages: write    # For GitHub Pages deployment
      id-token: write # For GitHub OIDC token
      pull-requests: write # For adding comments to PRs
    
    steps:
      # ==================== SETUP TEST REPO ====================
      
      - name: üì• Checkout Test Repo
        uses: actions/checkout@v4
        with:
          path: test-repo
      
      - name: üõ† Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'test-repo/package-lock.json'
          
      - name: üì¶ Install Allure CLI
        run: |
          # Install Allure using the official Debian package
          echo "Installing Allure CLI..."
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure_2.24.0-1_all.deb
          sudo dpkg -i allure_2.24.0-1_all.deb || sudo apt-get install -f -y
          # Verify installation
          echo "Allure version: $(allure --version || echo 'Allure not found')"
      
      - name: Install System Dependencies
        run: |
          echo "Updating package lists..."
          sudo apt-get update -qq
          
          echo "Installing required system dependencies for Ubuntu 24.04..."
          # Install all required system dependencies in a single command
          sudo apt-get install -y --no-install-recommends \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libatspi2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libx11-6 \
            libxcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            xvfb \
            x11-utils \
            x11-xserver-utils \
            libxtst6 \
            libasound2 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libx11-6 \
            libxcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxkbcommon0 \
            libxrandr2 \
            xvfb \
            x11-utils \
            x11-xserver-utils
          
          # Install Playwright system dependencies
          echo "Installing Playwright system dependencies..."
          npx playwright install --with-deps chromium
          npx playwright install-deps
          
          echo "System dependencies installed successfully"
      
      - name: Install Test Dependencies
        working-directory: ./test-repo
        run: |
          echo "Current directory: $(pwd)"
          echo "Setting up test-repo dependencies..."
          
          # Clean up previous installations
          echo "Cleaning up previous installations..."
          rm -rf node_modules package-lock.json
          
          # Create a fresh package.json
          echo "Creating package.json..."
          cat > package.json << 'EOL'
          {
            "name": "bank-tests",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "test": "playwright test"
            },
            "devDependencies": {
              "@playwright/test": "1.40.0",
              "allure-playwright": "2.0.0"
            }
          }
          EOL
          
          # Set npm registry and clean cache
          echo "Configuring npm..."
          npm config set registry https://registry.npmjs.org/
          npm cache clean --force
          
          # Install dependencies
          echo "Installing dependencies..."
          npm install --no-audit --no-fund --prefer-offline
          
          # Verify installation
          echo "Dependencies installed"
          echo "Installed packages:"
          npm list --depth=0
          
          # Install Playwright browsers (skip system dependencies as they're already installed)
          echo "Installing Playwright browsers..."
          npx playwright install chromium
          npx playwright --version

      - name: Clone APP Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.APP_REPO }}
          ref: ${{ env.APP_BRANCH }}
          path: app-repo
          # Use GITHUB_TOKEN (has access to public repos by default)
          # For private repos, add a PAT as APP_REPO_TOKEN secret
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üîß Setup Node.js for APP
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: üì¶ Install APP Dependencies
        working-directory: ./app-repo
        run: |
          echo "Installing dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi
      
      - name: üê≥ Setup Docker Configuration
        working-directory: ./app-repo
        run: |
          # Check if docker-compose.yml exists
          if [ ! -f "docker-compose.yml" ]; then
            echo "‚ö†Ô∏è  No docker-compose.yml found, creating one..."
            cat > docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            app:
              build: .
              ports:
                - "5001:5001"
              environment:
                - NODE_ENV=test
                - PORT=5001
              healthcheck:
                test: ["CMD-SHELL", "curl -f http://localhost:5001/health || curl -f http://localhost:5001/ || exit 1"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 30s
          EOF
          else
            echo "‚úÖ Found existing docker-compose.yml"
          fi
          
          # Check if Dockerfile exists
          if [ ! -f "Dockerfile" ]; then
            echo "‚ö†Ô∏è  No Dockerfile found, creating one..."
            cat > Dockerfile << 'EOF'
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production || npm install --production
          COPY . .
          EXPOSE 5001
          HEALTHCHECK --interval=10s --timeout=5s --start-period=30s \
            CMD wget --no-verbose --tries=1 --spider http://localhost:5001/health || exit 1
          CMD ["npm", "start"]
          EOF
          else
            echo "‚úÖ Found existing Dockerfile"
          fi
          
          echo "=== Docker Configuration ==="
          echo "Dockerfile:"
          cat Dockerfile
          echo ""
          echo "docker-compose.yml:"
          cat docker-compose.yml
      
      - name: üî® Build APP Docker Image
        working-directory: ./app-repo
        run: |
          echo "Building Docker image..."
          docker build -t vuln-bank:test .
          echo "‚úÖ Image built successfully"
          docker images | grep vuln-bank
      
      # ==================== START APP ====================
      
      - name: üöÄ Start APP Container
        working-directory: ./app-repo
        run: |
          echo "Starting application..."
          docker compose up -d
          echo "Waiting for container to initialize..."
          sleep 10
          echo "Container status:"
          docker compose ps
          docker ps
      
      - name: ‚è≥ Wait for APP to be Ready
        run: |
          echo "Waiting for application to respond..."
          timeout 120 bash -c '
            until curl -f http://localhost:5001/health 2>/dev/null || curl -f http://localhost:5001/ 2>/dev/null; do 
              echo "‚è≥ Waiting for app... ($(date +%T))"
              docker ps
              sleep 3
            done
          '
          echo "‚úÖ Application is ready!"
      
      - name: üîç Verify APP Endpoints
        run: |
          echo "=== Testing Endpoints ==="
          echo "Main endpoint:"
          curl -v http://localhost:5001/ 2>&1 | head -20 || echo "‚ùå Failed"
          
          echo ""
          echo "Health endpoint:"
          curl -v http://localhost:5001/health 2>&1 || echo "‚ö†Ô∏è  No health endpoint"
          
          echo ""
          echo "API endpoint:"
          curl -v http://localhost:5001/api/ 2>&1 || echo "‚ö†Ô∏è  No API endpoint"
      
      - name: üå± Seed Database with Test Users
        working-directory: ./test-repo
        run: |
          echo "Seeding database with fixture users..."
          node -e "
          const fs = require('fs');
          const http = require('http');
          
          // Read fixture users
          const users = JSON.parse(fs.readFileSync('tests/fixtures/users.json', 'utf8')).users;
          console.log('Found ' + users.length + ' users to seed');
          
          // Function to create user
          async function createUser(user) {
            return new Promise((resolve) => {
              const data = JSON.stringify({
                username: user.username || user.email.split('@')[0],
                email: user.email,
                password: user.password
              });
              
              const options = {
                hostname: 'localhost',
                port: 5001,
                path: '/api/register',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': data.length
                }
              };
              
              const req = http.request(options, (res) => {
                let body = '';
                res.on('data', (chunk) => body += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200 || res.statusCode === 201) {
                    console.log('‚úÖ Created user: ' + user.username);
                  } else if (res.statusCode === 409 || res.statusCode === 400) {
                    console.log('‚ÑπÔ∏è  User exists: ' + user.username);
                  } else {
                    console.log('‚ö†Ô∏è  Status ' + res.statusCode + ' for: ' + user.username);
                  }
                  resolve();
                });
              });
              
              req.on('error', (e) => {
                console.log('‚ùå Error creating ' + user.username + ': ' + e.message);
                resolve();
              });
              
              req.write(data);
              req.end();
            });
          }
          
          // Seed all users
          (async () => {
            for (const user of users.slice(0, 10)) {
              await createUser(user);
              await new Promise(r => setTimeout(r, 200));
            }
            console.log('‚úÖ Database seeding complete!');
          })();
          "
      
      - name: üìã Show APP Startup Logs
        if: always()
        working-directory: ./app-repo
        run: |
          echo "=== Application Logs (last 100 lines) ==="
          docker compose logs --tail=100
      
      # ==================== RUN TESTS ====================
      
      - name: üß™ Run Tests
        working-directory: ./test-repo
        env:
          BASE_URL: ${{ env.BASE_URL }}
          SECURITY_SOFT: ${{ env.SOFT_MODE }}
          ALLURE_RESULTS_DIR: ${{ env.ALLURE_RESULTS_DIR }}
        run: |
          echo "================================================"
          echo "üéØ Test Configuration"
          echo "================================================"
          echo "Target URL:    $BASE_URL"
          echo "SOFT mode:     $SECURITY_SOFT"
          echo "Test suite:    $TEST_SUITE"
          echo "APP branch:    $APP_BRANCH"
          echo "Allure Results: $ALLURE_RESULTS_DIR"
          echo "================================================"
          
          # Create test results directory
          mkdir -p $ALLURE_RESULTS_DIR
          
          # Run tests with Allure reporting
          EXIT_CODE=0
          echo "üîí Running $TEST_SUITE tests with Allure reporting..."
          
          # Run tests with Allure reporting and timeout
          echo "üöÄ Starting tests..."
          timeout 15m npx playwright test tests/$TEST_SUITE/ \
            --reporter=line,allure-playwright \
            --output=$ALLURE_RESULTS_DIR \
            --workers=2 \
            --timeout=300000 || EXIT_CODE=$?
            
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚ö†Ô∏è Tests timed out after 15 minutes"
            EXIT_CODE=0  # Don't fail the build on timeout
          fi
            
          # List generated test results
          echo "üìä Test results collected in: $ALLURE_RESULTS_DIR"
          find $ALLURE_RESULTS_DIR -type f | xargs ls -la 2>/dev/null || echo "No test results found"
          
          # Set status based on test results and SOFT_MODE
          if [ $EXIT_CODE -ne 0 ]; then
            if [ "$SECURITY_SOFT" = "true" ]; then
              echo "‚ö†Ô∏è  Tests found issues (SOFT mode - not failing build)"
              EXIT_CODE=0
            else
              echo "‚ùå Tests failed (HARD mode - failing build)"
            fi
          else
            echo "‚úÖ Tests completed successfully"
          fi
          
          exit $EXIT_CODE
      
      # ==================== GENERATE REPORTS ====================
      
      - name: üìä Generate Allure Report
        if: always()
        working-directory: ./test-repo
        env:
          ALLURE_RESULTS_DIR: ${{ env.ALLURE_RESULTS_DIR }}
          ALLURE_REPORT_DIR: ${{ env.ALLURE_REPORT_DIR }}
        run: |
          echo "=== Generating Allure Report ==="
          
          # Ensure directories exist
          mkdir -p "$ALLURE_RESULTS_DIR" "$ALLURE_REPORT_DIR"
          
          # Create a placeholder if no results found
          if [ -z "$(ls -A "$ALLURE_RESULTS_DIR/" 2>/dev/null)" ]; then
            echo '{"name": "No test results found", "status": "broken"}' > "$ALLURE_RESULTS_DIR/no-results.json"
            echo "‚ö†Ô∏è  No test results found. Using placeholder."
          fi
          
          # Generate the report
          echo "üìä Generating report from: $ALLURE_RESULTS_DIR"
          allure generate "$ALLURE_RESULTS_DIR" --clean -o "$ALLURE_REPORT_DIR"
          
          # Create a simple index if no report was generated
          if [ ! -f "$ALLURE_REPORT_DIR/index.html" ]; then
            echo "üìù Creating placeholder index.html..."
            echo "<h1>Allure Report</h1><p>No test results found. Check the test run for details.</p>" > "$ALLURE_REPORT_DIR/index.html"
          fi
          
          echo "‚úÖ Report generated at: $ALLURE_REPORT_DIR"
      
      - name: üöÄ Deploy Allure Report to GitHub Pages
        if: always()
        run: |
          echo "üöÄ Deploying Allure Report to GitHub Pages..."
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Deploy using gh-pages
          cd test-repo
          npx gh-pages -d allure-report \
            --repo https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}.git \
            --user "GitHub Actions <actions@github.com>" \
            --message "Deploy Allure Report [skip ci]" \
            --no-history
          
          echo "‚úÖ Report deployed to GitHub Pages"
      
      - name: üí¨ Add Report URL to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const reportUrl = `https://${context.repo.owner}.github.io/${context.repo.repo.split('/')[1]}/allure-report/`
            await github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üìä [View Allure Report](${reportUrl})`
            })
      
      - name: üì¶ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ github.run_number }}
          path: |
            test-repo/allure-results
            test-repo/allure-report
            test-repo/playwright-report
            test-repo/test-results
          retention-days: 7
      
      # ==================== COLLECT LOGS ====================
      
      - name: üìã Collect APP Logs
        if: always()
        working-directory: ./app-repo
        run: |
          mkdir -p ../app-logs
          echo "Collecting docker compose logs..."
          docker compose logs > ../app-logs/docker-compose.log 2>&1
          echo "Collecting container logs..."
          docker logs $(docker compose ps -q app) > ../app-logs/app-container.log 2>&1 || true
          echo "Collecting system info..."
          docker ps > ../app-logs/docker-ps.log 2>&1
          docker images > ../app-logs/docker-images.log 2>&1
      
      - name: üì§ Upload APP Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-logs-${{ github.run_number }}
          path: app-logs/
          retention-days: 30
      
      # ==================== CLEANUP ====================
      
      - name: üßπ Stop and Remove Containers
        if: always()
        working-directory: ./app-repo
        run: |
          echo "Stopping containers..."
          docker compose down -v --remove-orphans
          echo "Cleaning up Docker resources..."
          docker system prune -f
      
      - name: ‚úÖ Verify Cleanup
        if: always()
        run: |
          echo "=== Remaining Containers ==="
          docker ps -a
          echo ""
          echo "=== Remaining Volumes ==="
          docker volume ls
          echo ""
          echo "=== Disk Usage ==="
          docker system df
      
      # ==================== SUMMARY ====================
      
      - name: üìù Test Summary
        if: always()
        run: |
          echo "## üéØ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| APP Repo | \`${{ env.APP_REPO }}@${{ env.APP_BRANCH }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SOFT Mode | \`${{ env.SOFT_MODE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          
          # Add report URL
          REPORT_URL="https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/allure-report/"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- [View Allure Report]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          
          # Add test results summary if available
          if [ -d "test-repo/allure-results" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìà Test Statistics" >> $GITHUB_STEP_SUMMARY
            
            # Count test results
            TOTAL_TESTS=$(find test-repo/allure-results -name "*.json" | wc -l)
            PASSED_TESTS=$(grep -r "status\":\"passed\"" test-repo/allure-results | wc -l || echo 0)
            FAILED_TESTS=$(grep -r "status\":\"failed\"" test-repo/allure-results | wc -l || echo 0)
            
            echo "- ‚úÖ Passed: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- ‚ùå Failed: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- üìä Total: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          fi
          
      # ==================== DEPLOY TO GITHUB PAGES ====================
      
      - name: üöÄ Deploy to GitHub Pages
        if: always()
        run: |
          echo "üìÇ Current directory: $(pwd)"
          echo "üì¶ Files in test-repo/allure-report:"
          ls -la test-repo/allure-report/ || echo "No allure-report directory found"
          
          # Ensure the target directory exists
          mkdir -p test-repo/allure-report
          
          # Create a simple index.html if it doesn't exist
          if [ ! -f "test-repo/allure-report/index.html" ]; then
            echo "üìù Creating index.html..."
            echo "<h1>Allure Report</h1><p>Report will be available after first successful test run.</p>" > test-repo/allure-report/index.html
          fi
          
          # Deploy using the gh-pages package
          npm install -g gh-pages
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Deploy to gh-pages branch
          cd test-repo
          npx gh-pages -d allure-report \
            --repo https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git \
            --user "GitHub Actions <actions@github.com>" \
            --message "Deploy Allure Report [skip ci]"
          
      # ==================== SUMMARY ====================
      
      - name: üìù Test Summary
        if: always()
        run: |
          echo "## üéØ Security Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| APP Repo | \`${{ env.APP_REPO }}@${{ env.APP_BRANCH }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SOFT Mode | \`${{ env.SOFT_MODE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get the workflow run URL
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "### üìä Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- [View All Artifacts]($WORKFLOW_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Security Test Results]($WORKFLOW_URL/artifacts/$(echo -n \"test-results-${{ github.run_number }}\" | jq -sRr @uri))" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Application Logs]($WORKFLOW_URL/artifacts/$(echo -n \"app-logs-${{ github.run_number }}\" | jq -sRr @uri))" >> $GITHUB_STEP_SUMMARY
          
          # Add link to GitHub Pages Allure report
          if [ "${{ job.status }}" != "cancelled" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üåê Allure Report" >> $GITHUB_STEP_SUMMARY
            echo "- [View Latest Allure Report on GitHub Pages](https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/allure-report/)" >> $GITHUB_STEP_SUMMARY
            echo "- [Download Allure Report]($WORKFLOW_URL/artifacts/$(echo -n \"allure-report-${{ github.run_number }}\" | jq -sRr @uri))" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Full Workflow Run]($WORKFLOW_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [View All Security Test Runs](${{ github.server_url }}/${{ github.repository }}/actions/workflows/$(basename $GITHUB_WORKFLOW))" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Actions Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
